{% extends "main.html" %}

{% block content %}
{% include "header.html" %}


  <!-- GOOGLE PLUS SIGN IN-->
  <div id="signInButton">
      <span class="g-signin"
            data-scope="email"
            data-clientid="255502800037-kg2aokmi6dudta8rodq91ari17r82llk.apps.googleusercontent.com"
            data-redirecturi="postmessage"
            data-accesstype="offline"
            data-cookiepolicy="single_host_origin"
            data-callback="signInCallback">
      </span>
  </div>

  <div id="result"></div>

  <div id="getHandleForm" style="display:none"> 
    <h1> Welcome to Stock Market Savant!</h1>
    <h3> We have detected you are new around these parts.  Stock Market Savant is a game of fantasy stock portfolios</h3>
    <h3> You will have the oppurtunity to create your own portfolio and put your portfolio building skills to the test!</h3>
    <h3> Please enter the name you will be known on this website  </h3>
    <form action="/setup_account?state={{STATE}}" method="post">
      <div class="col-md-6">
         Stock Market Savant Handle name: <input type="text" name="handle_name" id="handleFormNameField">
      </div>
      <div class="col-md-6">
       <div id="handleStatus"> </div><br>
      </div>
      <input disabled type="submit" value="Submit" id="submitButton" >
    </form>

  </div>

  <script>
    function signInCallback(authResult) {
    if (authResult['code']) {
     
      // Hide the sign-in button now that the user is authorized
      $('#signInButton').attr('style', 'display:none');

      $.ajax({
        type: 'POST',
        url: '/gconnect?state={{STATE}}',
        processData: false,
        data: authResult['code'],
        contentType: 'application/octet-stream; charset=utf-8',
        dataType: 'json',
        success: function(result) { 
          if (result['handle'] == 'None' ) {
             $('#getHandleForm').attr('style', 'display:visible'); 
             $('#handleFormNameField').attr( 'value', result['handle'] );
          } 
          else {  window.location.href = "/"; }

          }//if (result).. else
      }); //Ajax
    }  //if authResult
    } //function
  </script>



  <script>
  $(document).ready(function(){
    $("#handleFormNameField").on('change keyup paste',function() {
        var name = $("#handleFormNameField").val();
        if(name.length < 4) 
        {
          $("#handleStatus").html('<font color="red">' + 
                            'The handle should have at least <strong>4</strong> characters.</font>');
          $("#handleFormNameField").removeClass('object_ok');
          $("#handleFormNameField").addClass('object_error');
          $("#submitButton").attr( 'disabled', 'disabled' );
        }
        else
        {
           $("#handleStatus").html('');
           $.ajax({ 
             type: "POST", 
             url: "verifyHandleUniqueness?handle=" + name,    
             contentType: "json",
             dataType: "json",
             success: function(result){ 
               if( result['return_value']  == 'unique' )
               {
                 $("#handleStatus").attr('style', 'display:none');
                 $("#handleFormNameField").removeClass('object_error');
                 $("#handleFormNameField").addClass('object_ok');
                 $("#submitButton").removeAttr( 'disabled' );
               }
               else
               {
                 $("#handleStatus").attr('style', 'display:visible');
                 $("#handleStatus").html('<font color="red"> Username is in use');
                 $("#handleFormNameField").removeClass('object_ok');
                 $("#handleFormNameField").addClass('object_error');
                 $("#submitButton").attr( 'disabled', 'disabled' );
               }
             }//end function
           });//end ajax
        }
       
    });//formNameField change()
  });//document.ready
  </script>


{% endblock %}

